import { match } from 'ts-pattern';

import { AbstractAggregate } from '@potentiel-domain/core';

import { LauréatAggregate } from '../lauréat.aggregate.js';

import {
  NatureDeLExploitationEvent,
  NatureDeLExploitationModifiéeEvent,
  TypeDeNatureDeLExploitation,
} from './index.js';

import { ImporterOptions } from './importer/importerNatureDeLExploitation.option.js';
import { NatureDeLExploitationImportéeEvent } from './importer/importerNatureDeLExploitation.event.js';
import { ModifierOptions } from './modifier/modifierNatureDeLExploitation.option.js';
import {
  NatureDeLExploitationDéjàTransmiseError,
  NatureDeLExploitationIdentiqueError,
  TauxPrévisionnelACIEnTropError,
  TauxPrévisionnelACIRequisError,
} from './natureDeLExploitation.error.js';
import { ChangementNatureDeLExploitationEnregistréEvent } from './changement/enregistrerChangement/enregistrerChangementNatureDeLExploitation.event.js';
import { EnregistrerChangementNatureDeLExploitationOptions } from './changement/enregistrerChangement/enregistrerChangementNatureDeLExploitation.option.js';

export class NatureDeLExploitationAggregate extends AbstractAggregate<
  NatureDeLExploitationEvent,
  'nature-de-l-exploitation',
  LauréatAggregate
> {
  #typeNatureDeLExploitation!: TypeDeNatureDeLExploitation.ValueType;
  #tauxPrévisionnelACI?: number;

  get lauréat() {
    return this.parent;
  }

  private get identifiantProjet() {
    return this.lauréat.projet.identifiantProjet;
  }

  async importer({
    typeNatureDeLExploitation,
    tauxPrévisionnelACI,
    importéeLe,
    importéePar,
  }: ImporterOptions) {
    if (this.exists) {
      throw new NatureDeLExploitationDéjàTransmiseError();
    }

    this.vérifierLaCohérenceDesDonnées(typeNatureDeLExploitation, tauxPrévisionnelACI);

    const event: NatureDeLExploitationImportéeEvent = {
      type: 'NatureDeLExploitationImportée-V1',
      payload: {
        identifiantProjet: this.identifiantProjet.formatter(),
        typeNatureDeLExploitation: typeNatureDeLExploitation.formatter(),
        tauxPrévisionnelACI,
        importéeLe: importéeLe.formatter(),
        importéePar: importéePar.formatter(),
      },
    };

    await this.publish(event);
  }

  async modifier({
    typeNatureDeLExploitation,
    tauxPrévisionnelACI,
    dateModification,
    identifiantUtilisateur,
    raison,
    pièceJustificative,
  }: ModifierOptions) {
    this.lauréat.vérifierQueLeLauréatExiste();
    this.vérifierLaCohérenceDesDonnées(typeNatureDeLExploitation, tauxPrévisionnelACI);

    const event: NatureDeLExploitationModifiéeEvent = {
      type: 'NatureDeLExploitationModifiée-V1',
      payload: {
        identifiantProjet: this.identifiantProjet.formatter(),
        typeNatureDeLExploitation: typeNatureDeLExploitation.formatter(),
        tauxPrévisionnelACI,
        modifiéeLe: dateModification.formatter(),
        modifiéePar: identifiantUtilisateur.formatter(),
        raison,
        pièceJustificative,
      },
    };

    await this.publish(event);
  }

  async enregistrerChangement({
    identifiantProjet,
    typeNatureDeLExploitation,
    tauxPrévisionnelACI,
    dateChangement,
    identifiantUtilisateur,
    pièceJustificative,
    raison,
  }: EnregistrerChangementNatureDeLExploitationOptions) {
    this.lauréat.vérifierQueLeChangementEstPossible(
      'information-enregistrée',
      'natureDeLExploitation',
    );
    this.vérifierLaCohérenceDesDonnées(typeNatureDeLExploitation, tauxPrévisionnelACI);

    const event: ChangementNatureDeLExploitationEnregistréEvent = {
      type: 'ChangementNatureDeLExploitationEnregistré-V1',
      payload: {
        identifiantProjet: identifiantProjet.formatter(),
        typeNatureDeLExploitation: typeNatureDeLExploitation.formatter(),
        tauxPrévisionnelACI,
        enregistréLe: dateChangement.formatter(),
        enregistréPar: identifiantUtilisateur.formatter(),
        raison,
        pièceJustificative,
      },
    };

    await this.publish(event);
  }

  apply(event: NatureDeLExploitationEvent): void {
    match(event)
      .with(
        {
          type: 'NatureDeLExploitationImportée-V1',
        },
        (event) => this.applyNatureDeLExploitationImportéeOuModifiéeV1(event),
      )
      .with(
        {
          type: 'NatureDeLExploitationModifiée-V1',
        },
        (event) => this.applyNatureDeLExploitationImportéeOuModifiéeV1(event),
      )
      .with(
        {
          type: 'ChangementNatureDeLExploitationEnregistré-V1',
        },
        (event) => this.applyNatureDeLExploitationImportéeOuModifiéeV1(event),
      )
      .exhaustive();
  }

  private applyNatureDeLExploitationImportéeOuModifiéeV1({
    payload: { typeNatureDeLExploitation, tauxPrévisionnelACI },
  }:
    | NatureDeLExploitationImportéeEvent
    | NatureDeLExploitationModifiéeEvent
    | ChangementNatureDeLExploitationEnregistréEvent) {
    this.#typeNatureDeLExploitation =
      TypeDeNatureDeLExploitation.convertirEnValueType(typeNatureDeLExploitation);
    this.#tauxPrévisionnelACI = tauxPrévisionnelACI;
  }

  private vérifierLaCohérenceDesDonnées(
    typeNatureDeLExploitation: TypeDeNatureDeLExploitation.ValueType,
    tauxPrévisionnelACI?: number,
  ) {
    if (
      typeNatureDeLExploitation.estÉgaleÀ(
        TypeDeNatureDeLExploitation.venteAvecInjectionEnSurplus,
      ) &&
      tauxPrévisionnelACI === undefined
    ) {
      throw new TauxPrévisionnelACIRequisError();
    }

    if (
      typeNatureDeLExploitation.estÉgaleÀ(
        TypeDeNatureDeLExploitation.venteAvecInjectionEnTotalité,
      ) &&
      tauxPrévisionnelACI !== undefined
    ) {
      throw new TauxPrévisionnelACIEnTropError();
    }

    if (
      // Pour traiter les événements en dehors de l'import
      this.#typeNatureDeLExploitation &&
      typeNatureDeLExploitation.estÉgaleÀ(this.#typeNatureDeLExploitation) &&
      this.#tauxPrévisionnelACI === tauxPrévisionnelACI
    ) {
      throw new NatureDeLExploitationIdentiqueError();
    }
  }
}
