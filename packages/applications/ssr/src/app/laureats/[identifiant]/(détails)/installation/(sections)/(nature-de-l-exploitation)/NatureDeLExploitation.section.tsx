import { mediator } from 'mediateur';

import { IdentifiantProjet, Lauréat } from '@potentiel-domain/projet';
import { Routes } from '@potentiel-applications/routes';
import { mapToPlainObject } from '@potentiel-domain/core';
import { Option } from '@potentiel-libraries/monads';

import { withUtilisateur } from '@/utils/withUtilisateur';
import { getAction } from '@/app/laureats/[identifiant]/_helpers/getAction';

import { Section } from '../../../(components)/Section';
import { getCahierDesCharges } from '../../../../../../_helpers';

import { NatureDeLExploitationDétails } from './NatureDeLExploitationDétails';

type NatureDeLExploitationSectionProps = {
  identifiantProjet: string;
};

export const NatureDeLExploitationSection = ({
  identifiantProjet: identifiantProjetValue,
}: NatureDeLExploitationSectionProps) =>
  withUtilisateur(async ({ rôle }) => {
    const identifiantProjet = IdentifiantProjet.convertirEnValueType(identifiantProjetValue);

    const cahierDesCharges = await getCahierDesCharges(identifiantProjet.formatter());

    if (!cahierDesCharges.getChampsSupplémentaires().natureDeLExploitation) {
      return null;
    }

    const projection =
      await mediator.send<Lauréat.NatureDeLExploitation.ConsulterNatureDeLExploitationQuery>({
        type: 'Lauréat.NatureDeLExploitation.Query.ConsulterNatureDeLExploitation',
        data: { identifiantProjet: identifiantProjet.formatter() },
      });

    const action = await getAction({
      identifiantProjet,
      rôle,
      domain: 'natureDeLExploitation',
      modifier: {
        permission: 'natureDeLExploitation.modifier',
        url: Routes.NatureDeLExploitation.modifier(identifiantProjet.formatter()),
        label: 'Modifier',
        labelActions: "Modifier la nature de l'exploitation",
      },
      demanderChangement: undefined,
      enregistrerChangement: {
        permission: 'natureDeLExploitation.enregistrerChangement',
        url: Routes.NatureDeLExploitation.changement.enregistrer(identifiantProjet.formatter()),
        label: "Changer la nature de l'exploitation",
        labelActions: "Changer la nature de l'exploitation",
      },
    });

    return (
      <Section title="Nature de l'exploitation">
        <NatureDeLExploitationDétails
          value={Option.isSome(projection) ? mapToPlainObject(projection) : undefined}
          action={action}
        />
      </Section>
    );
  });
