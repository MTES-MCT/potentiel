import { IdentifiantProjet } from '@potentiel-domain/projet';
import { mapToPlainObject } from '@potentiel-domain/core';

import { withUtilisateur } from '@/utils/withUtilisateur';
import { getAction } from '@/app/laureats/[identifiant]/_helpers/getAction';
import { getNatureDeLExploitationInfos } from '@/app/laureats/[identifiant]/_helpers/getLauréat';

import { Section } from '../../../(components)/Section';
import { getCahierDesCharges } from '../../../../../../_helpers';

import { NatureDeLExploitationDétails } from './NatureDeLExploitationDétails';

type NatureDeLExploitationSectionProps = {
  identifiantProjet: string;
};

export const NatureDeLExploitationSection = ({
  identifiantProjet: identifiantProjetValue,
}: NatureDeLExploitationSectionProps) =>
  withUtilisateur(async ({ rôle }) => {
    const identifiantProjet = IdentifiantProjet.convertirEnValueType(identifiantProjetValue);

    const cahierDesCharges = await getCahierDesCharges(identifiantProjet.formatter());

    if (!cahierDesCharges.getChampsSupplémentaires().natureDeLExploitation) {
      return null;
    }

    const natureDeLExploitation = await getNatureDeLExploitationInfos(
      identifiantProjet.formatter(),
    );
    const action = await getAction({
      identifiantProjet,
      rôle,
      domain: 'natureDeLExploitation',
    });

    return (
      <Section title="Nature de l'exploitation">
        <NatureDeLExploitationDétails
          value={natureDeLExploitation ? mapToPlainObject(natureDeLExploitation) : undefined}
          action={action}
        />
      </Section>
    );
  });
