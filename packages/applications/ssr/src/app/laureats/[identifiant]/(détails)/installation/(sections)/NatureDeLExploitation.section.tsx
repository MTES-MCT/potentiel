import { IdentifiantProjet } from '@potentiel-domain/projet';
import { mapToPlainObject } from '@potentiel-domain/core';

import { withUtilisateur } from '@/utils/withUtilisateur';
import {
  getAction,
  getNatureDeLExploitationInfos,
  SectionWithErrorHandling,
} from '@/app/laureats/[identifiant]/_helpers';
import { getCahierDesCharges } from '@/app/_helpers';

import { Section } from '../../(components)/Section';

import { NatureDeLExploitationDétails } from './NatureDeLExploitationDétails';

type NatureDeLExploitationSectionProps = {
  identifiantProjet: IdentifiantProjet.RawType;
};

const sectionTitle = "Nature de l'exploitation";

export const NatureDeLExploitationSection = ({
  identifiantProjet: identifiantProjetValue,
}: NatureDeLExploitationSectionProps) =>
  SectionWithErrorHandling(
    withUtilisateur(async ({ rôle }) => {
      const identifiantProjet = IdentifiantProjet.convertirEnValueType(identifiantProjetValue);

      const cahierDesCharges = await getCahierDesCharges(identifiantProjet.formatter());

      if (!cahierDesCharges.getChampsSupplémentaires().natureDeLExploitation) {
        return null;
      }

      const natureDeLExploitation = await getNatureDeLExploitationInfos(
        identifiantProjet.formatter(),
      );
      const action = await getAction({
        identifiantProjet,
        rôle,
        domain: 'natureDeLExploitation',
      });

      return (
        <Section title={sectionTitle}>
          <NatureDeLExploitationDétails
            value={natureDeLExploitation ? mapToPlainObject(natureDeLExploitation) : undefined}
            action={action}
          />
        </Section>
      );
    }),
    sectionTitle,
  );
